---
id: account-recovery-password-reset
title: Account recovery and password reset
---

import useBaseUrl from "@docusaurus/useBaseUrl"
import Mermaid from "@site/src/theme/Mermaid"
import ApiWarning from "@site/src/theme/ApiWarning"
import SelfServiceBrowserFlow from "@site/src/theme/SelfServiceBrowserFlow"
import SelfServiceSpaFlow from "@site/src/theme/SelfServiceSpaFlow"
import SelfServiceApiFlow from "@site/src/theme/SelfServiceApiFlow"

import CodeTabs from "@site/src/theme/Code/CodeTabs"
import {
  getFlowMethodLinkWithErrors,
  getFlowMethodLinkSuccess,
  getFlowMethodLinkInvalidChallenge,
  getFlowMethodLinkChallengeDone,
} from "./self-service/flows/code/recovery"
import RenderFlow from "@site/src/theme/Code/RenderFlow"

import DomainWarning from "@site/src/theme/DomainWarning"
import AjaxWarning from "@site/src/theme/AjaxWarning"
import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"

Account Recovery allows registered users to regain access to their account if they lost their password or means of multi-factor
authentication (MFA).

## Methods

If a user lost access to their account, they need to prove ownership of the account. This is typically done via a recovery
address, such as an email address or phone number. By having access to these addresses they prove ownership of the account.

Ory Kratos supports two recovery methods:

- Sending a one-time password (**preferred**)
- Sending a "magic link"

### Configuring self-service account recovery

<Tabs
  defaultValue="oss"
  values={[
    {label: 'Ory Cloud', value: 'oc'},
    {label: 'Ory Kratos', value: 'oss'}
  ]}>
  <TabItem value="oc">

Account recovery can be configured in the **Customize** > **Account Recovery** screen of the
[Ory Cloud Console](https://console.ory.sh/guides).

  </TabItem>
  <TabItem value="oss">

    You can configure which methods to use in the Ory Kratos config:

```yaml title="path/to/my/kratos/config.yml"
selfservice:
  methods:
    code: # this enables the one time password method
      enabled: true
      config:
        # Defines how long a recovery code is valid for (default 1h)
        lifespan: 15m

  flows:
    recovery:
      enabled: true

      # Defines how long a recovery flow (the UI interaction) is valid for (default 1h)
      lifespan: 15m
      use: code
```

  </TabItem>
</Tabs>

### Account recovery addresses

To provide the account recovery mechanism, Ory Kratos needs to know which address to send the recovery message to. This can be set
in the identity schema of the user. In most cases, this is the address that the user used when registering their account. But Ory
Kratos supports other fields inside the `traits` section as well.

:::note

If the email address used for recovery purposes is the same as the email used for verification purposes and the account hasn't yet
been activated (see [Account Activation](./self-service/flows/verify-email-account-activation.mdx)) - the address will be marked
as verified in Ory Kratos.

:::

To specify that a trait of the identity should be used for recovery, use the following identity schema:

```diff
 {
   "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",
   "$schema": "http://json-schema.org/draft-07/schema#",
   "title": "Person",
   "type": "object",
   "properties": {
     "traits": {
       "type": "object",
       "properties": {
         "email": {
           "type": "string",
           "format": "email",
           "ory.sh/kratos": {
             "credentials": {
               "password": {
                 "identifier": true
               }
             },
+            "recovery": {
+              "via": "email"
+            }
           }
         }
       }
       "additionalProperties": false
     }
   }
 }
```

### Email Templates

<p>
  <figure>
    <img alt="Recovery email sent to unknown address" src={useBaseUrl("images/kratos/email-recovery-unknown.png")} />
    <figcaption>
      If the requested email address is an unknown recovery address, an account recovery attempt email is sent to that email
      address.
    </figcaption>
  </figure>
</p>

This prevents account enumeration attacks as explained in this
[blog post by Troy Hunt](https://www.troyhunt.com/website-enumeration-insanity-how-our-personal-data-is-leaked/).

<p>
  <figure>
    <img alt="Recovery email sent to a known recovery address" src={useBaseUrl("images/kratos/email-recovery-known.png")} />
    <figcaption>
      If the requested email address is a known recovery address, a recovery link is sent to that email address.
    </figcaption>
  </figure>
</p>

The emails are using templates that can be customized as explained in
[Customizing E-Mail Templates](emails-sms/custom-email-templates).

### Privileged session age

After the user completed the recovery successfully, e.g. by clicking on the magic link or entering the one-time password, they are
issued a privileged session. This is done to allow them to update their password.

The maximum age of this session can be configured:

<Tabs
  defaultValue="oss"
  values={[
    {label: 'Ory Cloud Platform', value: 'ocp'},
    {label: 'Ory Kratos', value: 'oss'}
  ]}>
  <TabItem value="ocp">

Configuring the privileged session duration will be possible in the future.

  </TabItem>
  <TabItem value="oss">

You can configure the privileged session duration in the Ory Kratos config:

```yaml title="path/to/kratos/config.yml"
selfservice:
  flows:
    settings:
      privileged_session_max_age: 15m
```

  </TabItem>
</Tabs>

### One-time passwords vs. magic links

The one-time password method (`code`) is preferred, as magic links have multiple drawbacks:

- Email virus scanners sometimes open magic links to scan them. This invalidates the link and a user may not be able to recover
  their account.
- API flows initialized by apps on mobile phones or smart devices are not possible when using magic links.
- Annoying new browser tabs - worse UX

Ory Kratos uses one-time passwords by default. Magic links are available for legacy reasons and will be removed in the future.

## Code examples for Node.js, React.js, Go, ...

The Recovery User Interface is a route (page / site) in your application (server, native app, single page app) that should render
a recovery form.

In stark contrast to other Identity Systems, Ory Kratos doesn't render this HTML. Instead, you need to implement the HTML code in
your application (for example Node.js + Express.js, Java, PHP, React.js, ...), which gives you extreme flexibility and
customizability in your user interface flows and designs.

You will use the Recovery Flow JSON response to render the recovery form UI, which could looks as follows depending on your
programming language and web framework:

<RenderFlow flow="recovery" />
