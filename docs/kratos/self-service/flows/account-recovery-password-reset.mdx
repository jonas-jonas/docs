---
id: account-recovery-password-reset
title: Account recovery and password reset
---

import useBaseUrl from "@docusaurus/useBaseUrl"
import Mermaid from "@site/src/theme/Mermaid"
import ApiWarning from "@site/src/theme/ApiWarning"
import SelfServiceBrowserFlow from "@site/src/theme/SelfServiceBrowserFlow"
import SelfServiceSpaFlow from "@site/src/theme/SelfServiceSpaFlow"
import SelfServiceApiFlow from "@site/src/theme/SelfServiceApiFlow"

import CodeTabs from "@site/src/theme/Code/CodeTabs"
import {
  getFlowMethodLinkWithErrors,
  getFlowMethodLinkSuccess,
  getFlowMethodLinkInvalidChallenge,
  getFlowMethodLinkChallengeDone,
} from "./code/recovery"
import RenderFlow from "@site/src/theme/Code/RenderFlow"

import DomainWarning from "@site/src/theme/DomainWarning"
import AjaxWarning from "@site/src/theme/AjaxWarning"
import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"

Account Recovery allows registered users to regain access to their account if they lost their password or multifactor
authentication (MFA) provider.

If a user loses the credentials to their account, they need to prove ownership of the account to recover access. This is typically done via a recovery address such as an email address or phone number. The user can prove their identity by accessing a link or one-time code sent to a recovery address.

Ory Identities (Ory Kratos) supports two recovery methods:

- Sending a one-time password (**preferred**)
- Sending a "magic link"

## Configuring self-service account recovery

<Tabs
  defaultValue="oc"
  values={[
    {label: 'The Ory Network', value: 'oc'},
    {label: 'Self-hosted Ory Kratos config', value: 'oss'}
  ]}>
  <TabItem value="oc">

Account recovery can be configured in the **Customize** > **Account Recovery** screen of the
[Ory Network Console](https://console.ory.sh/guides).

  </TabItem>
  <TabItem value="oss">

You can configure which methods to use in the Ory Kratos config:

```yaml title="path/to/my/kratos/config.yml"
selfservice:
  methods:
    code: # this enables the one time password method
      enabled: true
      config:
        # Defines how long a recovery code is valid for (default 1h)
        lifespan: 15m

  flows:
    recovery:
      enabled: true

      # Defines how long a recovery flow (the UI interaction) is valid for (default 1h)
      lifespan: 15m
      use: code # Define which strategy to use, either `code` or `link`
```

Keep in mind, that both methods require sending out emails to your users, so an SMTP server is required. Read more
[here](../../emails-sms/01_sending-emails-smtp.mdx).

  </TabItem>
</Tabs>

## Account recovery addresses

To start account recovery, Ory Identities (Ory Kratos) needs to know which address to send the recovery message to. In most cases this is the address the user provided when registering their account. Other fields inside the `traits` section are supported as well.

:::note

If the email address used for recovery is the same as the email used for verification but the account hasn't
been activated yet (see [Account Activation](./verify-email-account-activation.mdx)), the address will also be verified by
completing the account recovery successfully.

:::

To specify a trait of the identity to be used for recovery, use the following identity schema:

```diff
 {
   "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",
   "$schema": "http://json-schema.org/draft-07/schema#",
   "title": "Person",
   "type": "object",
   "properties": {
     "traits": {
       "type": "object",
       "properties": {
         "email": {
           "type": "string",
           "format": "email",
           "ory.sh/kratos": {
             "credentials": {
               "password": {
                 "identifier": true
               }
             },
+            "recovery": {
+              "via": "email"
+            }
           }
         }
       }
       "additionalProperties": false
     }
   }
 }
```

## Email templates

<p>
  <figure>
    <img alt="Recovery email sent to unknown address" src={useBaseUrl("images/kratos/email-recovery-unknown.png")} />
    <figcaption>
      If the requested email address is an unknown recovery address, an account recovery attempt email is sent to that email
      address.
    </figcaption>
  </figure>
</p>

This prevents account enumeration attacks as explained in this
[blog post by Troy Hunt](https://www.troyhunt.com/website-enumeration-insanity-how-our-personal-data-is-leaked/).

<p>
  <figure>
    <img alt="Recovery email sent to a known recovery address" src={useBaseUrl("images/kratos/email-recovery-known.png")} />
    <figcaption>
      If the requested email address is a known recovery address, a recovery code is sent to that email address.
    </figcaption>
  </figure>
</p>

The emails are using templates that can be customized as explained in
[Customizing E-Mail Templates](../../emails-sms/custom-email-templates).

## Updating credentials

After the user completes the recovery successfully they receive a privileged session and are redirected to the settings page to update their credentials.

Read more about the [privileged sessions](../../session-management/01_overview.mdx#privileged-sessions).

## Invalidate other sessions

In some scenarios it can be useful to revoke all active sessions once an account has been recovered. This forces anyone with access to the account to re-authenticate.

```diff
 selfservice:
   flows:
     recovery:
       enabled: true
       ui_url: http://127.0.0.1:4455/recovery
+      after:
+        hooks:
+        - hook: revoke_active_sessions
```

## One-time passwords vs. magic links

The one-time password method (`code`) is preferred, as magic links have multiple drawbacks:

- Some email virus scanners open links in emails to scan them. This invalidates the magic link and a user may not be able to
  recover their account.
- API flows initialized by apps on mobile phones or smart devices are not possible when using magic links.
- Magic links often open in different browsers than the one used to initialize the flow, depending on the user's device settings.
  This may result in a confusing user experience for your users.

Ory Identities (Ory Kratos) uses one-time passwords by default. Magic links are available for legacy reasons and will be removed
in the future.

:::important

When updating an existing project from the `link` method to use the `code` method, there might be changes in the behavior of the
UI. Double-check the flow after updating your configuration.

:::

## Multifactor authentication

By design, the account recovery process bypasses the primary account credential. You can choose to require multifactor authentication for account recovery.

<Tabs
  defaultValue="oc"
  values={[
    {label: 'The Ory Network', value: 'oc'},
    {label: 'Self-hosted Ory Kratos config', value: 'oss'}
  ]}>
  <TabItem value="oc">
On the Ory Network Console go to <b>Two-Factor Authentication</b> and disable "Allow Self-Service Settings without Second Factor".
  </TabItem>
  <TabItem value="oss">

```yaml title="path/to/my/kratos/config.yml"
selfservice:
  flows:
    settings:
      required_aal: highest_available
```

  </TabItem>
</Tabs>

## Code examples for Node.js, React.js, Go

The recovery user interface is a page in your own application (server, native app, single page app) that should render the actual
form elements for the user.

In contrast to other identity systems, the Ory Identities (Ory Kratos) doesn't render this HTML directly. Instead, you need
to implement the HTML code in your application (for example in Node.js + Express.js, Java, PHP, React.js, ...), which gives you
complete flexibility and customizability in your user interface flows and designs. This part of your application then directly
interfaces with Ory Identities through an API.

The API responds with a JSON document describing the form elements to render and actions the form should take upon submission, cancellation, etc. The following shows examples for a few different languages and frameworks.

<RenderFlow flow="recovery" />
